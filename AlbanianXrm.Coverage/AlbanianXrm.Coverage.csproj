<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>   
    <ProjectGuid>{6E7020D4-A279-4D8E-B5D6-DEA31FAEF370}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AssemblyName>AlbanianXrm.EarlyBound.Coverage</AssemblyName>
    <TargetFramework>net462</TargetFramework>
    <Configurations>Debug;Release;Azure Pipelines</Configurations>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="OpenCover" Version="4.7.922">
      <GeneratePathProperty>true</GeneratePathProperty>
      <PrivateAssets>All</PrivateAssets>
      <ExcludeAssets>All</ExcludeAssets>
    </PackageReference>
    <PackageReference Include="ReportGenerator" Version="4.8.4">
      <GeneratePathProperty>true</GeneratePathProperty>
      <PrivateAssets>All</PrivateAssets>
      <ExcludeAssets>All</ExcludeAssets>
    </PackageReference>   
    <PackageReference Include="xunit.runner.console" Version="2.4.1">
      <GeneratePathProperty>true</GeneratePathProperty>
      <PrivateAssets>all</PrivateAssets>
      <ExcludeAssets>All</ExcludeAssets>
      <IncludeAssets>none</IncludeAssets>
    </PackageReference>   
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\AlbanianXrm.CrmSvcUtilExtensions.Tests\AlbanianXrm.CrmSvcUtilExtensions.Tests.csproj" />
    <ProjectReference Include="..\AlbanianXrm.CrmSvcUtilExtensions\AlbanianXrm.CrmSvcUtilExtensions.csproj">
      <PrivateAssets>all</PrivateAssets>
      <ExcludeAssets>All</ExcludeAssets>
      <IncludeAssets>none</IncludeAssets>
    </ProjectReference>
    <ProjectReference Include="..\AlbanianXrm.ForrestSerializer.Tests\AlbanianXrm.ForrestSerializer.Tests.csproj" />
    <ProjectReference Include="..\AlbanianXrm.ForrestSerializer\AlbanianXrm.ForrestSerializer.csproj">
      <PrivateAssets>all</PrivateAssets>
      <ExcludeAssets>All</ExcludeAssets>
      <IncludeAssets>none</IncludeAssets>
    </ProjectReference>
  </ItemGroup>
  <ItemDefinitionGroup>
    <Reference>
      <Private>False</Private>
    </Reference>
    <ProjectReference>
      <Private>False</Private>
    </ProjectReference>
  </ItemDefinitionGroup>
  <Target Name="PostBuild" AfterTargets="PostBuildEvent">   
    <ItemGroup>
      <ProjectReference Condition="$([System.String]::Copy('%(Filename)').EndsWith('.Test')) OR $([System.String]::Copy('%(Filename)').EndsWith('.Tests'))">
        <ProjectBeingTested>$([System.String]::Copy('%(Filename)').Substring(0, $([System.String]::Copy('%(Filename)').LastIndexOf('.Test'))))</ProjectBeingTested>
      </ProjectReference>
    </ItemGroup>
    <PropertyGroup>
      <AlbanianXrmReports Condition="'$(AlbanianXrmReports)'==''">Html;Cobertura</AlbanianXrmReports>
      <_AlbanianXrmCoverageOutput Condition="$([System.String]::Copy('%(Filename)').EndsWith('.Test')) OR $([System.String]::Copy('%(Filename)').EndsWith('.Tests'))">@(ProjectReference->'$(OutDir)%(Filename).Coverage.xml')</_AlbanianXrmCoverageOutput>
    </PropertyGroup>
    <Error Condition="'$(_AlbanianXrmCoverageOutput)'==''" Code="ALBXRMCOV1" Text="No test projects have been configured as Project Reference" />
    <Exec Condition="$([System.String]::Copy('%(Filename)').EndsWith('.Test')) OR $([System.String]::Copy('%(Filename)').EndsWith('.Tests'))" Command="&quot;$(PkgOpenCover)\tools\OpenCover.Console.exe&quot; -target:&quot;$(Pkgxunit_runner_console)\tools\net47\xunit.console.exe&quot; -targetargs:&quot;&quot;&quot;%(ProjectReference.RelativeDir)\bin\$(ConfigurationName)\net462\%(ProjectReference.FileName).dll&quot;&quot; -noshadow&quot; -output:&quot;$(OutDir)%(ProjectReference.FileName).Coverage.xml&quot; -register:Path64 -filter:&quot;+[%(ProjectReference.ProjectBeingTested)]* -[%(ProjectReference.FileName)]*&quot;" />
    <Exec Command="&quot;$(PkgReportGenerator)\tools\net47\ReportGenerator.exe&quot; -reports:&quot;$(_AlbanianXrmCoverageOutput)&quot; -targetdir:&quot;$(TargetDir)CoverageReport&quot; -reporttypes:&quot;$(AlbanianXrmReports)&quot;" />
  </Target>
</Project>